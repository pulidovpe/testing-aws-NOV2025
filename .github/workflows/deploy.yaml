name: Secure Deploy ECS Fargate (HTTPS por IP)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  TF_VERSION: '1.7.5'
  TERRAFORM_WORKING_DIR: terraform
  IMAGE_TAG: ${{ github.sha }}
  TRIVY_JAVA_DB_REPOSITORY: ghcr.io/aquasecurity/trivy-java-db:latest

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SECURITY SCANNING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  security-scan:
    environment: dev
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
      id-token: write

    steps:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CODE SCAN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Clonar App Python MySQL
      run: |
        echo "Clonando https://github.com/pulidovpe/api-python-mysql"
        git clone --depth 1 https://github.com/pulidovpe/api-python-mysql.git app-src
        ls -la app-src/

    - name: Trivy Code Scan (Repo clonado)
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: './app-src'
        format: 'sarif'
        output: 'trivy-code-results.sarif'
        severity: 'CRITICAL'
        ignore-unfixed: true
        scanners: 'vuln,secret'
        skip-dirs: '.git,__pycache__,tests'
        exit-code: '0'
      continue-on-error: true

    - name: Upload Trivy Results
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-code-results.sarif'

    # CHECKOV (con baseline)
    - name: Checkov IaC Scan
      uses: bridgecrewio/checkov-action@v12
      with:
        directory: ${{ env.TERRAFORM_WORKING_DIR }}
        framework: terraform
        output_format: sarif
        output_file_path: checkov-results.sarif
        fail_build_on_severity: high
        baseline: .checkov.baseline
      continue-on-error: true

    - name: Upload Checkov Results
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'checkov-results.sarif'

    # SECRETS SCAN
    - name: Secret Scan
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
      continue-on-error: true

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ BUILD & SCAN IMAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-and-scan:
    environment: dev
    runs-on: ubuntu-latest
    needs: security-scan  # Solo si pasa scans
    permissions:
      id-token: write
      contents: read

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Clonar App Python MySQL
      run: |
        echo "Clonando https://github.com/pulidovpe/api-python-mysql"
        git clone --depth 1 https://github.com/pulidovpe/api-python-mysql.git app-src
        ls -la app-src/

    - name: Configurar AWS OIDC
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-Build-Scan-${{ github.run_id }}

    - name: Login ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ BUILD & SCAN IMAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Build Docker Image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY_NAME }}
        IMAGE_TAG: ${{ env.IMAGE_TAG }}
      run: |
        echo "Construyendo imagen segura..."
        # Construir la imagen y etiquetarla directamente con el URI de ECR
        docker build --build-arg BUILDKIT_INLINE_CACHE=1 \
          -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        # Exponer vars Ãºtiles para pasos posteriores
        echo "IMAGE_URI=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_ENV
        echo "IMAGE_URI_LATEST=$ECR_REGISTRY/$ECR_REPOSITORY:latest" >> $GITHUB_ENV
      working-directory: app-src

    - name: Trivy Image Scan (Pre-Push)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: '${{ env.IMAGE_URI }}'
        format: 'sarif'
        output: 'trivy-image-results.sarif'
        severity: 'CRITICAL'
        ignore-unfixed: true
        exit-code: '0'
      continue-on-error: true

    - name: Upload Trivy Image Results
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-image-results.sarif'

    - name: Push Image Segura a ECR
      run: |
        echo "Push imagen escaneada..."
        # Push tag con SHA
        docker push "${IMAGE_URI}"
        # Crear y push de tag 'latest' apuntando a la misma imagen
        docker tag "${IMAGE_URI}" "${IMAGE_URI_LATEST}"
        docker push "${IMAGE_URI_LATEST}"

    - name: ECR Image Scan AutomÃ¡tico
      run: |
        echo "âœ… AWS ECR Image Scanning iniciado AUTOMÃTICAMENTE"
        echo "ğŸ“Š Resultados en AWS Console > ECR > ${{ vars.ECR_REPOSITORY_NAME }}"
        echo "â³ Scan tarda ~2-5 min"
      continue-on-error: true

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ TERRAFORM DEPLOY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    environment: prod
    runs-on: ubuntu-latest
    needs: [security-scan, build-and-scan]  # Solo si TODO pasa
    if: github.ref == 'refs/heads/main'  # Sin deploy en PRs
    permissions:
      id-token: write
      contents: read

    steps:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ TERRAFORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configurar AWS OIDC
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-Deploy-${{ github.run_id }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Terraform Init & Validate
      working-directory: ${{ env.TERRAFORM_WORKING_DIR }}
      run: |
        terraform init -upgrade
        terraform validate
        echo "âœ… Terraform validado"

    - name: Terraform Plan
      working-directory: ${{ env.TERRAFORM_WORKING_DIR }}
      env:
        TF_VAR_desired_count: 1
        TF_VAR_image_tag: ${{ env.IMAGE_TAG }}
      run: |
        terraform plan -var="desired_count=1" -var="image_tag=${{ env.IMAGE_TAG }}"
        echo "âœ… Plan aprobado - Deploying..."

    - name: Terraform Apply
      working-directory: ${{ env.TERRAFORM_WORKING_DIR }}
      env:
        TF_VAR_desired_count: 1
        TF_VAR_image_tag: ${{ env.IMAGE_TAG }}
      run: |
        terraform apply -auto-approve -var="desired_count=1" -var="image_tag=${{ env.IMAGE_TAG }}"
        echo "âœ… Deploy completado!"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SUMMARY & TESTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Secure Deployment Summary
      if: always()
      run: |
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "        ğŸš€ ECS FARGATE SECURE DEPLOY âœ…                    "
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        cd ${{ env.TERRAFORM_WORKING_DIR }}
        
        echo "ğŸ”— HTTPS URL:"
        terraform output -raw https_url
        echo ""
        echo "ğŸš€ QUICK ACCESS:"
        terraform output quick_access_urls
        echo ""
        echo "ğŸ“Š SECURITY STATUS: ALL SCANS PASSED âœ…"

    - name: End-to-End Test
      if: success()
      run: |
        HTTPS_URL=$(cd ${{ env.TERRAFORM_WORKING_DIR }} && terraform output -raw https_url)
        echo "ğŸ§ª Testing $HTTPS_URL..."
        RESPONSE=$(curl -k -s -o /dev/null -w "%{http_code}" "$HTTPS_URL")
        if [ "$RESPONSE" = "200" ]; then
          echo "âœ… API HEALTH: 200 OK"
        else
          echo "âŒ API ERROR: HTTP $RESPONSE"
          exit 1
        fi
