name: Secure Deploy ECS Fargate (HTTPS por IP)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  pull-requests: write
  issues: write

env:
  TF_VERSION: '1.12.2'
  TERRAFORM_WORKING_DIR: ${{ github.workspace }}/terraform/envs/test
  IMAGE_TAG: ${{ github.sha }}
  TRIVY_JAVA_DB_REPOSITORY: ghcr.io/aquasecurity/trivy-java-db:latest
  TERRAFORM_BACKEND:  ${{ github.workspace }}/terraform/backend/test.hcl
  TOKEN: ${{ secrets.GH_PAT }}

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SECURITY SCANNING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  security-scan:
    environment: dev
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
      id-token: write

    steps:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CODE SCAN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Clonar App Python MySQL
      run: |
        echo "Clonando https://github.com/pulidovpe/api-python-mysql"
        git clone --depth 1 https://${{ env.TOKEN }}@github.com/pulidovpe/api-python-mysql.git app-src
        ls -la app-src/

    - name: Trivy Code Scan (Repo clonado)
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: './app-src'
        format: 'sarif'
        output: 'trivy-code-results.sarif'
        severity: 'CRITICAL'
        ignore-unfixed: true
        scanners: 'vuln,secret'
        skip-dirs: '.git,__pycache__,tests'
        exit-code: '0'
      continue-on-error: true

    - name: Upload Trivy Results
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-code-results.sarif'

    # CHECKOV (con baseline)
    - name: Checkov IaC Scan
      uses: bridgecrewio/checkov-action@v12
      with:
        directory: ${{ env.TERRAFORM_WORKING_DIR }}
        framework: terraform
        output_format: sarif
        output_file_path: checkov-results.sarif
        fail_build_on_severity: high
        baseline: .checkov.baseline
      continue-on-error: true

    - name: Upload Checkov Results
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'checkov-results.sarif'

    # SECRETS SCAN
    - name: Secret Scan
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
      continue-on-error: true

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ BUILD & SCAN IMAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-and-scan:
    environment: dev
    runs-on: ubuntu-latest
    needs: security-scan
    permissions:
      id-token: write
      contents: read
      security-events: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: ğŸ”„ Clonar App Python MySQL
      run: |
        echo "ğŸ“¦ Clonando app-src..."
        git clone --depth 1 https://github.com/pulidovpe/api-python-mysql.git app-src
        ls -la app-src/
        cd app-src && ls -la

    - name: ğŸ” Configurar AWS OIDC
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHub-OIDC-TERRAFORM
        
    # BUILD LOCAL (SIN ECR LOGIN)
    - name: ğŸ—ï¸ Build Imagen LOCAL
      working-directory: app-src
      run: |
        IMAGE_TAG="${{ env.IMAGE_TAG }}"
        echo "ğŸ—ï¸ Building local: api-python-app:$IMAGE_TAG"
        
        docker build \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          -t api-python-app:$IMAGE_TAG \
          .
        
        echo "âœ… Build completado"
        docker images | grep api-python-app

    # TRIVY SCAN LOCAL
    - name: ğŸ›¡ï¸ Trivy Image Scan (Local)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'api-python-app:${{ env.IMAGE_TAG }}'
        format: 'sarif'
        output: 'trivy-image-results.sarif'
        severity: 'CRITICAL'
        ignore-unfixed: true
        exit-code: '0'
      continue-on-error: true

    - name: Upload Trivy Results
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-image-results.sarif'

    # ECR LOGIN (DESPUÃ‰S de build/scan)
    - name: Login ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    # TAG PARA ECR
    - name: Tag Images para ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY_NAME }}
        IMAGE_TAG: ${{ env.IMAGE_TAG }}
      run: |
        echo "ğŸ”Œ Registry: $ECR_REGISTRY"
        echo "ğŸ“¦ Repository: $ECR_REPOSITORY"
        
        # Verificar registry NO vacÃ­o
        if [ -z "$ECR_REGISTRY" ]; then
          echo "âŒ ECR_REGISTRY vacÃ­o!"
          exit 1
        fi
        
        # Tags ECR
        docker tag api-python-app:$IMAGE_TAG \
          $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        
        docker tag api-python-app:$IMAGE_TAG \
          $ECR_REGISTRY/$ECR_REPOSITORY:latest
        
        # Export vars
        echo "IMAGE_URI=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_ENV
        echo "IMAGE_URI_LATEST=$ECR_REGISTRY/$ECR_REPOSITORY:latest" >> $GITHUB_ENV
        
        echo "âœ… Tags creados:"
        docker images | grep $ECR_REPOSITORY

    # PUSH FINAL
    - name: Push Images a ECR
      run: |
        echo "ğŸš€ Pushing images..."
        docker push "${{ env.IMAGE_URI }}"
        docker push "${{ env.IMAGE_URI_LATEST }}"
        echo "âœ… Images pushed successfully!"

    - name: ECR Scan AutomÃ¡tico
      run: |
        echo "âœ… AWS ECR Image Scan iniciado automÃ¡ticamente"
        echo "ğŸ“Š Ver en: AWS Console > ECR > ${{ vars.ECR_REPOSITORY_NAME }}"
      continue-on-error: true

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ TERRAFORM DEPLOY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    environment: prod
    runs-on: ubuntu-latest
    needs: [security-scan, build-and-scan]  # Solo si TODO pasa
    if: github.ref == 'refs/heads/main'  # Sin deploy en PRs
    permissions:
      id-token: write
      contents: read

    steps:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ TERRAFORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configurar AWS OIDC
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHub-OIDC-TERRAFORM

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Terraform Init & Validate
      id: validate
      run: |
        terraform init -reconfigure -backend-config=${{ env.TERRAFORM_BACKEND }}
        terraform validate -no-color
        echo "âœ… Terraform validado"
      working-directory: ${{ env.TERRAFORM_WORKING_DIR }}

    - name: Terraform Plan      
      env:
        TF_VAR_desired_count: 1
        TF_VAR_image_tag: ${{ env.IMAGE_TAG }}
      run: |
        terraform plan -var="desired_count=1" -var="image_tag=${{ env.IMAGE_TAG }}" -var-file="terraform.tfvars" -out=tfplan -no-color
        echo "âœ… Plan aprobado - Deploying..."
      working-directory: ${{ env.TERRAFORM_WORKING_DIR }}
      continue-on-error: true
      
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ APPROVAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Approval-Action
      id: approval
      uses: ekeel/approval-action@v1.0.3
      with:
        token: ${{ secrets.GH_PAT }}
        approvers: 'pulidovpe'
        minimumApprovals: '1'
        issueLabels: 'ManualApproval,ApprovalAction'
        excludeInitiator: 'false'
        approveWords: 'approved, aprobado'
        rejectWords: 'denied, rechazado'
        waitInterval: '1'
        waitTimeout: '3'
        issueTitle: 'Deployment request approval'
        issueBody: |
          #### Terraform Initialization and Validation ğŸ¤–\`${{ steps.validate.outcome }}\`

          <details><summary>Validation Output</summary>

          \`\`\`
          ${{ steps.validate.outputs.stdout }}
          \`\`\`

          </details>

          #### Terraform Plan ğŸ“–\`${{ steps.plan.outcome }}\`

          <details><summary>Show Plan</summary>

          \`\`\`
          ${{ steps.plan.outputs.stdout }}
          \`\`\`

          </details>

          *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          })

    - name: Terraform Apply      
      env:
        TF_VAR_desired_count: 1
        TF_VAR_image_tag: ${{ env.IMAGE_TAG }}
      run: |
        terraform apply -var="desired_count=1" -var="image_tag=${{ env.IMAGE_TAG }}" -var-file="terraform.tfvars" -auto-approve tfplan
        echo "âœ… Deploy completado!"
      working-directory: ${{ env.TERRAFORM_WORKING_DIR }}

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SUMMARY & TESTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Secure Deployment Summary
      if: always()
      run: |
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "        ğŸš€ ECS FARGATE SECURE DEPLOY âœ…                    "
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        cd ${{ env.TERRAFORM_WORKING_DIR }}
        
        echo "ğŸ”— HTTPS URL:"
        terraform output -raw https_url
        echo ""
        echo "ğŸš€ QUICK ACCESS:"
        terraform output quick_access_urls
        echo ""
        echo "ğŸ“Š SECURITY STATUS: ALL SCANS PASSED âœ…"

    - name: End-to-End Test
      if: success()
      run: |
        HTTPS_URL=$(cd ${{ env.TERRAFORM_WORKING_DIR }} && terraform output -raw https_url)
        echo "ğŸ§ª Testing $HTTPS_URL..."
        RESPONSE=$(curl -k -s -o /dev/null -w "%{http_code}" "$HTTPS_URL")
        if [ "$RESPONSE" = "200" ]; then
          echo "âœ… API HEALTH: 200 OK"
        else
          echo "âŒ API ERROR: HTTP $RESPONSE"
          exit 1
        fi
